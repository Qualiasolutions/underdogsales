---
phase: 02-user-dashboard-progress
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/progress.ts
  - src/lib/actions/curriculum.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "getScoreTrends returns array of {date, score} for user's sessions"
    - "getDimensionAverages returns Record<ScoreDimension, number> for radar chart"
    - "getCurriculumProgress returns module completion data"
    - "recharts is installed and importable"
  artifacts:
    - path: "src/lib/actions/progress.ts"
      provides: "Score trend and dimension average aggregation"
      exports: ["getScoreTrends", "getDimensionAverages"]
    - path: "src/lib/actions/curriculum.ts"
      provides: "Curriculum progress server action"
      exports: ["getCurriculumProgress"]
  key_links:
    - from: "src/lib/actions/progress.ts"
      to: "supabase roleplay_sessions + session_scores"
      via: "getAdminClient queries"
      pattern: "supabase.*from.*roleplay_sessions|session_scores"
    - from: "src/lib/actions/curriculum.ts"
      to: "supabase curriculum_progress"
      via: "getAdminClient queries"
      pattern: "supabase.*from.*curriculum_progress"
---

<objective>
Install recharts and create server actions for progress data aggregation.

Purpose: Provide the data layer for curriculum progress and performance trend visualizations.
Output: Three new server actions (getScoreTrends, getDimensionAverages, getCurriculumProgress) and recharts dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-dashboard-progress/02-RESEARCH.md

# Existing patterns
@src/lib/actions/practice-session.ts (pagination pattern, getUser, getAdminClient)
@src/types/index.ts (ScoreDimension type)
@src/config/curriculum.ts (12 modules, module IDs 1-12)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts</name>
  <files>package.json, package-lock.json</files>
  <action>
    Install recharts for data visualization:
    ```bash
    npm install recharts
    ```

    Note: react-is is already included with React 19, no need to install separately.
  </action>
  <verify>npm ls recharts shows version ^3.x installed</verify>
  <done>recharts is in package.json dependencies and can be imported</done>
</task>

<task type="auto">
  <name>Task 2: Create progress server actions</name>
  <files>src/lib/actions/progress.ts</files>
  <action>
    Create new file `src/lib/actions/progress.ts` with two server actions:

    1. **getScoreTrends(limit = 20)**
       - Get user via getUser()
       - Query roleplay_sessions with session_scores for current user
       - Order by created_at ascending (oldest to newest for trend line)
       - Calculate average score per session
       - Return array of { date: string, score: number }
       - Format date as "Jan 15" using toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
       - Round score to 1 decimal place
       - Return empty array if no user or no sessions

    2. **getDimensionAverages()**
       - Get user via getUser()
       - Query session_scores joined with roleplay_sessions to filter by user
       - Group scores by dimension
       - Calculate average for each of 6 dimensions
       - Return Record<ScoreDimension, number> with all 6 dimensions
       - If dimension has no scores, use 0
       - Round averages to 1 decimal place
       - Return object with all 6 dimensions set to 0 if no user or no scores

    Follow existing patterns from practice-session.ts:
    - 'use server' directive
    - Import getUser from @/lib/supabase/server
    - Import getAdminClient from @/lib/supabase/admin
    - Import ScoreDimension from @/types
    - Use try/catch with logger.exception
    - Return graceful defaults on error

    The 6 dimensions are: opener, pitch, discovery, objection_handling, closing, communication
  </action>
  <verify>npx tsc --noEmit (no type errors in new file)</verify>
  <done>Both getScoreTrends and getDimensionAverages export correctly, return properly typed data</done>
</task>

<task type="auto">
  <name>Task 3: Create curriculum progress server action</name>
  <files>src/lib/actions/curriculum.ts</files>
  <action>
    Create new file `src/lib/actions/curriculum.ts` with server action:

    **getCurriculumProgress()**
    - Get user via getUser()
    - Query curriculum_progress table filtered by user_id
    - Return array of objects with:
      - moduleId: number (1-12)
      - completed: boolean
      - score: number | null
      - completedAt: string | null
    - For modules without progress records, return completed: false
    - Ensure all 12 modules are represented (fill in missing ones)
    - Return empty progress for all 12 modules if no user

    Database schema reference (from migrations):
    - curriculum_progress: id, user_id, module_id, completed, score, completed_at

    Follow same patterns as progress.ts:
    - 'use server' directive
    - Import getUser, getAdminClient, logger
    - Try/catch with graceful defaults
  </action>
  <verify>npx tsc --noEmit (no type errors in new file)</verify>
  <done>getCurriculumProgress returns array of 12 module progress objects</done>
</task>

</tasks>

<verification>
```bash
# Verify recharts installed
npm ls recharts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify exports exist
grep -l "export async function getScoreTrends" src/lib/actions/progress.ts
grep -l "export async function getDimensionAverages" src/lib/actions/progress.ts
grep -l "export async function getCurriculumProgress" src/lib/actions/curriculum.ts
```
</verification>

<success_criteria>
- recharts ^3.x is in package.json dependencies
- src/lib/actions/progress.ts exports getScoreTrends and getDimensionAverages
- src/lib/actions/curriculum.ts exports getCurriculumProgress
- All server actions follow existing patterns (getUser, getAdminClient, try/catch)
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-dashboard-progress/02-01-SUMMARY.md`
</output>
