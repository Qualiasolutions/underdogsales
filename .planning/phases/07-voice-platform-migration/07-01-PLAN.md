---
phase: 07-voice-platform-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/config/personas.ts
  - src/lib/retell/client.ts
  - src/lib/retell/auth.ts
  - src/app/api/retell/webhook/route.ts
autonomous: true
user_setup:
  - service: retell
    why: "Voice AI platform replacing VAPI"
    env_vars:
      - name: RETELL_API_KEY
        source: "Retell Dashboard -> Settings -> API Keys"
    dashboard_config:
      - task: "Create 6 Retell LLM + Agent pairs matching existing VAPI personas"
        location: "Retell Dashboard -> Agents"
      - task: "Set webhook URL to {SITE_URL}/api/retell/webhook"
        location: "Retell Dashboard -> Agent Settings -> Webhook"

must_haves:
  truths:
    - "Persona type includes optional retellAgentId field"
    - "Retell client can register web calls and handle events"
    - "Webhook endpoint validates Retell signatures"
    - "Webhook logs call lifecycle events"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Persona with retellAgentId"
      contains: "retellAgentId"
    - path: "src/lib/retell/client.ts"
      provides: "Retell web client wrapper"
      exports: ["getRetellClient", "startRetellSession", "stopRetellSession", "muteRetellSession"]
    - path: "src/lib/retell/auth.ts"
      provides: "Webhook signature verification"
      exports: ["verifyRetellSignature"]
    - path: "src/app/api/retell/webhook/route.ts"
      provides: "Webhook handler"
      exports: ["POST", "GET"]
  key_links:
    - from: "src/lib/retell/client.ts"
      to: "/api/retell/register"
      via: "fetch call for access token"
      pattern: "fetch.*api/retell/register"
    - from: "src/app/api/retell/webhook/route.ts"
      to: "src/lib/retell/auth.ts"
      via: "signature verification"
      pattern: "verifyRetellSignature"
---

<objective>
Set up Retell SDK infrastructure including types, client library, and webhook endpoint.

Purpose: Create the backend foundation for Retell voice integration before connecting to the frontend.
Output: Working Retell client library, webhook endpoint, and updated types ready for VoicePractice integration.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-voice-platform-migration/07-RESEARCH.md

Key existing files to reference:
@src/lib/vapi/client.ts (pattern to follow)
@src/lib/vapi/auth.ts (signature verification pattern)
@src/app/api/vapi/webhook/route.ts (webhook pattern)
@src/types/index.ts (Persona interface)
@src/config/personas.ts (persona definitions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Retell SDKs and update types</name>
  <files>
    package.json
    src/types/index.ts
    src/config/personas.ts
  </files>
  <action>
1. Install Retell packages:
   ```bash
   npm install retell-client-js-sdk retell-sdk
   ```

2. Update Persona interface in src/types/index.ts:
   - Add optional `retellAgentId?: string` field after `assistantId`
   - Keep assistantId for VAPI backward compatibility

3. Update personas in src/config/personas.ts:
   - Add placeholder retellAgentId field to each persona (empty string for now)
   - Comment: "// TODO: Replace with actual Retell agent IDs after dashboard setup"
   - Example: `retellAgentId: '', // Retell agent ID (set after migration)`
  </action>
  <verify>
    - `npm ls retell-sdk retell-client-js-sdk` shows both packages installed
    - `grep -n "retellAgentId" src/types/index.ts` shows the new field
    - `grep -c "retellAgentId" src/config/personas.ts` returns 6 (one per persona)
  </verify>
  <done>
    - Retell SDKs installed
    - Persona type has retellAgentId field
    - All 6 personas have placeholder retellAgentId
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Retell client library</name>
  <files>
    src/lib/retell/client.ts
    src/lib/retell/auth.ts
  </files>
  <action>
1. Create src/lib/retell/client.ts mirroring src/lib/vapi/client.ts pattern:
   - Import RetellWebClient from 'retell-client-js-sdk'
   - Singleton pattern: getRetellClient() returns cached RetellWebClient instance
   - RetellSessionOptions interface matching RoleplaySessionOptions:
     - persona: Persona
     - scenarioType: 'cold_call' | 'objection' | 'closing' | 'gatekeeper'
     - onTranscript?: (entry: TranscriptEntry) => void
     - onCallStart?: (callId: string) => void
     - onCallEnd?: () => void
     - onError?: (error: Error) => void
   - startRetellSession(options): async function
     - Fetch /api/retell/register with POST, body: { agentId: persona.retellAgentId, metadata: { personaId, scenarioType } }
     - On success, get { accessToken, callId }
     - Set up event handlers: 'call_started', 'call_ended', 'update', 'error'
     - Call retell.startCall({ accessToken })
     - Return callId
   - stopRetellSession(): void - calls retell.stopCall()
   - muteRetellSession(muted: boolean): void - calls retell.mute() or retell.unmute()

2. Create src/lib/retell/auth.ts:
   - Import Retell from 'retell-sdk'
   - Export verifyRetellSignature(rawBody: string, signature: string | null): boolean
     - If no RETELL_API_KEY, log warning, return false
     - Use Retell.verify(rawBody, signature || '', process.env.RETELL_API_KEY!)
     - Return verification result
  </action>
  <verify>
    - File exists: `test -f src/lib/retell/client.ts && echo "OK"`
    - File exists: `test -f src/lib/retell/auth.ts && echo "OK"`
    - Exports check: `grep -E "export (async )?function" src/lib/retell/client.ts`
    - TypeScript compiles: `npx tsc --noEmit src/lib/retell/client.ts src/lib/retell/auth.ts 2>&1 | head -5` (should be clean or only type errors from missing deps)
  </verify>
  <done>
    - Retell client wrapper exists with singleton pattern
    - startRetellSession, stopRetellSession, muteRetellSession exported
    - verifyRetellSignature auth function exported
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Retell webhook endpoint</name>
  <files>
    src/app/api/retell/webhook/route.ts
  </files>
  <action>
Create src/app/api/retell/webhook/route.ts following src/app/api/vapi/webhook/route.ts pattern:

1. Imports:
   - NextRequest, NextResponse from 'next/server'
   - verifyRetellSignature from '@/lib/retell/auth'
   - logger from '@/lib/logger'

2. POST handler:
   - Read raw body: `await request.text()`
   - Get signature: `request.headers.get('x-retell-signature')`
   - Verify signature using verifyRetellSignature, return 401 if invalid
   - Parse payload: `JSON.parse(rawBody)`
   - Extract { event, call } from payload
   - Switch on event:
     - 'call_started': Log info with callId
     - 'call_ended': Log info with callId, duration (end_timestamp - start_timestamp), disconnection_reason
     - 'call_analyzed': Log info with callId, hasAnalysis
     - default: Log debug for unknown event
   - Return NextResponse with status 204 (no content)

3. GET handler (health check):
   - Return JSON: { status: 'active', endpoint: '/api/retell/webhook', supported_events: ['call_started', 'call_ended', 'call_analyzed'] }

4. Add comment at top noting session saving happens client-side (matching VAPI pattern)
  </action>
  <verify>
    - File exists: `test -f src/app/api/retell/webhook/route.ts && echo "OK"`
    - Has POST: `grep -c "export async function POST" src/app/api/retell/webhook/route.ts` returns 1
    - Has GET: `grep -c "export async function GET" src/app/api/retell/webhook/route.ts` returns 1
    - Uses auth: `grep -c "verifyRetellSignature" src/app/api/retell/webhook/route.ts` returns 1
  </verify>
  <done>
    - Webhook endpoint exists at /api/retell/webhook
    - Signature verification enforced
    - Handles call_started, call_ended, call_analyzed events
    - Health check endpoint available via GET
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Package verification:
   ```bash
   npm ls retell-sdk retell-client-js-sdk
   ```

2. TypeScript compilation (full project):
   ```bash
   npm run typecheck
   ```

3. File structure check:
   ```bash
   ls -la src/lib/retell/
   ls -la src/app/api/retell/
   ```

4. Exports verification:
   ```bash
   grep "export" src/lib/retell/client.ts
   grep "export" src/lib/retell/auth.ts
   ```
</verification>

<success_criteria>
- Both Retell SDKs installed and importable
- Persona type extended with retellAgentId (optional field)
- All 6 personas have placeholder retellAgentId in config
- Retell client library exports: getRetellClient, startRetellSession, stopRetellSession, muteRetellSession
- Retell auth exports: verifyRetellSignature
- Webhook endpoint handles POST with signature verification
- Webhook endpoint handles GET for health check
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-voice-platform-migration/07-01-SUMMARY.md`
</output>
