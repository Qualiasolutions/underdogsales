---
phase: 07-voice-platform-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/api/retell/register/route.ts
  - src/components/voice/VoicePractice.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can start voice practice with Retell when feature flag enabled"
    - "Access token is fetched server-side before starting call"
    - "Transcript appears in real-time during Retell call"
    - "Call can be ended and session saves correctly"
    - "VAPI still works when Retell is disabled"
  artifacts:
    - path: "src/app/api/retell/register/route.ts"
      provides: "Web call registration endpoint"
      exports: ["POST"]
    - path: "src/components/voice/VoicePractice.tsx"
      provides: "Voice practice with Retell support"
      contains: ["startRetellSession", "VOICE_PROVIDER"]
  key_links:
    - from: "src/components/voice/VoicePractice.tsx"
      to: "/api/retell/register"
      via: "startRetellSession fetch"
      pattern: "startRetellSession"
    - from: "src/app/api/retell/register/route.ts"
      to: "retell.call.createWebCall"
      via: "Retell SDK"
      pattern: "createWebCall"
---

<objective>
Integrate Retell into VoicePractice component with feature flag toggle.

Purpose: Enable users to practice with Retell voice AI while maintaining VAPI fallback during migration.
Output: Working voice practice using Retell SDK with environment-based feature flag.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-voice-platform-migration/07-RESEARCH.md
@.planning/phases/07-voice-platform-migration/07-01-SUMMARY.md

Key existing files to reference:
@src/lib/retell/client.ts (from Plan 01)
@src/components/voice/VoicePractice.tsx (component to modify)
@src/lib/vapi/client.ts (current implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Retell register endpoint</name>
  <files>
    src/app/api/retell/register/route.ts
  </files>
  <action>
Create src/app/api/retell/register/route.ts for web call registration:

1. Imports:
   - NextRequest, NextResponse from 'next/server'
   - Retell from 'retell-sdk'
   - createClient from '@/lib/supabase/server'
   - logger from '@/lib/logger'

2. Initialize Retell client at module level:
   ```typescript
   const retell = new Retell({ apiKey: process.env.RETELL_API_KEY! })
   ```

3. POST handler:
   - Authenticate user via Supabase: `const supabase = await createClient()`, get user
   - If no user, return 401 Unauthorized
   - Parse request body: { agentId, metadata }
   - Validate agentId exists, return 400 if missing
   - Call retell.call.createWebCall:
     ```typescript
     const response = await retell.call.createWebCall({
       agent_id: agentId,
       metadata: {
         ...metadata,
         userId: user.id,
       },
     })
     ```
   - Return JSON: { accessToken: response.access_token, callId: response.call_id }
   - Wrap in try/catch, log errors, return 500 on failure

4. Add proper error handling with structured logging
  </action>
  <verify>
    - File exists: `test -f src/app/api/retell/register/route.ts && echo "OK"`
    - Has POST: `grep -c "export async function POST" src/app/api/retell/register/route.ts` returns 1
    - Uses Supabase auth: `grep -c "createClient" src/app/api/retell/register/route.ts` returns 1
    - Creates web call: `grep -c "createWebCall" src/app/api/retell/register/route.ts` returns 1
  </verify>
  <done>
    - Register endpoint exists at /api/retell/register
    - Requires authentication
    - Returns access_token and call_id
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Retell into VoicePractice component</name>
  <files>
    src/components/voice/VoicePractice.tsx
  </files>
  <action>
Modify src/components/voice/VoicePractice.tsx to support both VAPI and Retell:

1. Add feature flag constant at top of file:
   ```typescript
   // Voice provider feature flag - set to 'retell' to use Retell, 'vapi' for VAPI
   const VOICE_PROVIDER = (process.env.NEXT_PUBLIC_VOICE_PROVIDER || 'vapi') as 'vapi' | 'retell'
   ```

2. Add Retell imports (conditional import pattern not needed - both will be bundled):
   ```typescript
   import {
     startRetellSession,
     stopRetellSession,
     muteRetellSession,
   } from '@/lib/retell/client'
   ```

3. Find the startCall function (around line 350-400). Modify to support both providers:
   ```typescript
   const startCall = useCallback(async () => {
     // ... existing setup code (setStatus, etc.) ...

     try {
       if (VOICE_PROVIDER === 'retell') {
         if (!selectedPersona.retellAgentId) {
           throw new Error('Retell agent not configured for this persona')
         }
         const callId = await startRetellSession({
           persona: selectedPersona,
           scenarioType: selectedScenario,
           onTranscript: handleTranscript,
           onCallStart: handleCallStart,
           onCallEnd: handleCallEnd,
           onError: handleError,
         })
         setCurrentCallId(callId)
       } else {
         // Existing VAPI logic
         const callId = await startRoleplaySession({
           persona: selectedPersona,
           scenarioType: selectedScenario,
           onTranscript: handleTranscript,
           onCallStart: handleCallStart,
           onCallEnd: handleCallEnd,
           onError: handleError,
         })
         setCurrentCallId(callId)
       }
     } catch (error) {
       // ... existing error handling ...
     }
   }, [/* existing deps */])
   ```

4. Find the endCall function. Modify to support both providers:
   ```typescript
   const endCall = useCallback(() => {
     if (VOICE_PROVIDER === 'retell') {
       stopRetellSession()
     } else {
       stopRoleplaySession()
     }
     // ... existing cleanup code ...
   }, [/* existing deps */])
   ```

5. Find the toggleMute function. Modify to support both providers:
   ```typescript
   const toggleMute = useCallback(() => {
     const newMuted = !isMuted
     setIsMuted(newMuted)
     if (VOICE_PROVIDER === 'retell') {
       muteRetellSession(newMuted)
     } else {
       muteRoleplaySession(newMuted)
     }
   }, [isMuted])
   ```

6. Add visual indicator showing which provider is active (optional, for debugging):
   - In the ConnectionIndicator area, add small badge if VOICE_PROVIDER === 'retell'
   - Can be a simple text like "(Retell)" next to the connection status

IMPORTANT: Keep all existing VAPI logic intact. We're adding Retell as an alternative, not replacing VAPI.
  </action>
  <verify>
    - Has feature flag: `grep -c "VOICE_PROVIDER" src/components/voice/VoicePractice.tsx` returns at least 3
    - Imports Retell: `grep -c "startRetellSession" src/components/voice/VoicePractice.tsx` returns at least 2
    - Still has VAPI: `grep -c "startRoleplaySession" src/components/voice/VoicePractice.tsx` returns at least 1
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    - VoicePractice supports both VAPI and Retell
    - Feature flag controls which provider is used
    - VAPI remains default (no breaking changes)
    - All voice functions (start, stop, mute) work with both providers
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Retell integration with register endpoint and VoicePractice component update.
    Feature flag controls VAPI vs Retell provider.
  </what-built>
  <how-to-verify>
    1. Verify build passes:
       ```bash
       npm run build
       ```

    2. Start dev server:
       ```bash
       npm run dev
       ```

    3. Test with VAPI (default):
       - Open http://localhost:3000/practice
       - Select a persona and scenario
       - Start a call - should work as before with VAPI

    4. Test Retell preparation (without actual agents):
       - Check /api/retell/webhook health: `curl http://localhost:3000/api/retell/webhook`
       - Should return JSON with status: 'active'

    5. (Optional) If Retell agents are configured:
       - Add `NEXT_PUBLIC_VOICE_PROVIDER=retell` to .env.local
       - Add `RETELL_API_KEY=your_key` to .env.local
       - Update persona retellAgentIds in src/config/personas.ts
       - Restart dev server and test a call
  </how-to-verify>
  <resume-signal>Type "approved" if build passes and VAPI still works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build check:
   ```bash
   npm run build
   ```

2. TypeScript check:
   ```bash
   npm run typecheck
   ```

3. API structure check:
   ```bash
   ls -la src/app/api/retell/
   ```

4. Feature flag check:
   ```bash
   grep "VOICE_PROVIDER" src/components/voice/VoicePractice.tsx
   ```

5. Health check (with dev server running):
   ```bash
   curl http://localhost:3000/api/retell/webhook
   ```
</verification>

<success_criteria>
- Register endpoint creates web calls via Retell SDK
- VoicePractice component supports both VAPI and Retell
- Feature flag (NEXT_PUBLIC_VOICE_PROVIDER) controls provider selection
- VAPI remains the default provider (backward compatible)
- Build passes without errors
- Existing VAPI functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/07-voice-platform-migration/07-02-SUMMARY.md`
</output>
