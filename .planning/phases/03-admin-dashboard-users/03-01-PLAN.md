---
phase: 03-admin-dashboard-users
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/admin.ts
  - src/lib/actions/admin.ts
  - src/lib/hooks/use-debounce.ts
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "isAdmin() checks email against whitelist and returns boolean"
    - "getAllUsers() returns paginated user list with activity metrics"
    - "getUserDetail() returns single user with full session history"
    - "Admin routes are protected in middleware"
    - "useDebounce hook works for search input"
  artifacts:
    - path: "src/config/admin.ts"
      provides: "Admin email whitelist and isAdmin helper"
      exports: ["isAdmin", "ADMIN_EMAILS"]
    - path: "src/lib/actions/admin.ts"
      provides: "Admin server actions for user data"
      exports: ["getAllUsers", "getUserDetail"]
    - path: "src/lib/hooks/use-debounce.ts"
      provides: "Debounce hook for search"
      exports: ["useDebounce"]
  key_links:
    - from: "src/lib/actions/admin.ts"
      to: "supabase users + roleplay_sessions + session_scores"
      via: "getAdminClient queries with joins"
      pattern: "getAdminClient.*from.*users"
    - from: "middleware.ts"
      to: "src/config/admin.ts"
      via: "isAdmin check for /admin routes"
      pattern: "isAdmin.*admin"
---

<objective>
Create admin infrastructure: config, server actions, middleware protection, and debounce hook.

Purpose: Establish the data layer and security foundation for admin dashboard.
Output: Admin email whitelist, user management server actions, middleware protection, debounce utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-dashboard-users/03-CONTEXT.md
@.planning/phases/03-admin-dashboard-users/03-RESEARCH.md

# Existing patterns
@src/lib/actions/practice-session.ts (server action pattern)
@src/lib/actions/progress.ts (aggregation pattern)
@src/lib/supabase/admin.ts (getAdminClient)
@src/lib/supabase/server.ts (getUser)
@middleware.ts (route protection pattern)
@src/lib/supabase/types.ts (Database types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin email whitelist config</name>
  <files>src/config/admin.ts</files>
  <action>
    Create `src/config/admin.ts`:

    ```typescript
    /**
     * Admin Configuration
     *
     * Simple email-based admin check. Add emails to the whitelist
     * to grant admin access.
     */

    export const ADMIN_EMAILS = [
      'fawzi@qualiasolutions.io',
      // Add more admin emails as needed
    ] as const

    /**
     * Check if an email has admin privileges
     */
    export function isAdmin(email: string | undefined | null): boolean {
      if (!email) return false
      return ADMIN_EMAILS.includes(email.toLowerCase() as typeof ADMIN_EMAILS[number])
    }
    ```

    Note: Keep it simple per CONTEXT.md decision - hardcoded email whitelist.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>isAdmin function exists and correctly checks email against whitelist</done>
</task>

<task type="auto">
  <name>Task 2: Create useDebounce hook</name>
  <files>src/lib/hooks/use-debounce.ts</files>
  <action>
    Create `src/lib/hooks/use-debounce.ts`:

    ```typescript
    'use client'

    import { useEffect, useState } from 'react'

    /**
     * Debounce a value by the specified delay
     *
     * @param value - The value to debounce
     * @param delay - Delay in milliseconds (default 300ms)
     * @returns The debounced value
     *
     * @example
     * ```tsx
     * const [search, setSearch] = useState('')
     * const debouncedSearch = useDebounce(search, 300)
     *
     * useEffect(() => {
     *   // This runs 300ms after search stops changing
     *   fetchResults(debouncedSearch)
     * }, [debouncedSearch])
     * ```
     */
    export function useDebounce<T>(value: T, delay = 300): T {
      const [debouncedValue, setDebouncedValue] = useState<T>(value)

      useEffect(() => {
        const timer = setTimeout(() => {
          setDebouncedValue(value)
        }, delay)

        return () => {
          clearTimeout(timer)
        }
      }, [value, delay])

      return debouncedValue
    }
    ```

    Simple, no external dependency needed.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>useDebounce hook exists and handles cleanup correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create admin server actions</name>
  <files>src/lib/actions/admin.ts</files>
  <action>
    Create `src/lib/actions/admin.ts` with these server actions:

    1. **getAllUsers(options)**
       - Verify admin with getUser() + isAdmin()
       - Parameters: { search?: string, limit?: number, offset?: number }
       - Query users table with join to roleplay_sessions for activity
       - Return: { users, hasMore, error? }
       - User object includes: id, email, name, role, created_at, session_count, last_active, average_score
       - Use getAdminClient() for RLS bypass
       - Search filters by email OR name (case-insensitive)
       - Order by created_at descending (newest first)
       - Calculate session_count from joined sessions
       - Calculate last_active from most recent session (or created_at if none)
       - Calculate average_score from session_scores (0 if none)

    2. **getUserDetail(userId)**
       - Verify admin with getUser() + isAdmin()
       - Parameters: userId string
       - Return full user data plus their sessions with scores
       - Return: { user, sessions, error? }
       - Sessions include: id, persona_id, scenario_type, duration_seconds, created_at, scores[]
       - Order sessions by created_at descending

    Follow existing patterns:
    - 'use server' directive
    - Import getUser from @/lib/supabase/server
    - Import getAdminClient from @/lib/supabase/admin
    - Import isAdmin from @/config/admin
    - Import logger from @/lib/logger
    - Try/catch with logger.exception
    - Return graceful defaults with error messages on auth failure

    Type definitions:
    ```typescript
    export interface AdminUser {
      id: string
      email: string
      name: string
      role: string | null
      created_at: string
      session_count: number
      last_active: string
      average_score: number
    }

    export interface AdminSession {
      id: string
      persona_id: string
      scenario_type: string
      duration_seconds: number | null
      created_at: string
      scores: Array<{ dimension: string; score: number; feedback: string | null }>
    }
    ```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>getAllUsers and getUserDetail export correctly with proper types and admin verification</done>
</task>

<task type="auto">
  <name>Task 4: Update middleware for admin routes</name>
  <files>middleware.ts</files>
  <action>
    Update `middleware.ts` to protect admin routes:

    1. Import isAdmin from @/config/admin

    2. Add admin route check after the protected routes check:
       ```typescript
       // Admin routes - require admin privileges
       const isAdminRoute = request.nextUrl.pathname.startsWith('/admin')

       if (isAdminRoute) {
         if (!user) {
           const redirectUrl = new URL('/login', request.url)
           redirectUrl.searchParams.set('redirect', request.nextUrl.pathname)
           return NextResponse.redirect(redirectUrl)
         }

         if (!isAdmin(user.email)) {
           // Non-admins get redirected to home
           return NextResponse.redirect(new URL('/', request.url))
         }
       }
       ```

    3. Update the matcher config to include admin routes:
       ```typescript
       matcher: [
         '/practice/:path*',
         '/dashboard/:path*',
         '/settings/:path*',
         '/profile/:path*',
         '/curriculum/:path*',
         '/admin/:path*',  // Add this
         '/login',
         '/signup'
       ],
       ```

    Note: Admin check uses isAdmin(user.email) which checks against the whitelist.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Middleware protects /admin/* routes with admin email check</done>
</task>

</tasks>

<verification>
```bash
# Verify TypeScript compiles
npx tsc --noEmit

# Verify exports exist
grep -l "export function isAdmin" src/config/admin.ts
grep -l "export function useDebounce" src/lib/hooks/use-debounce.ts
grep -l "export async function getAllUsers" src/lib/actions/admin.ts
grep -l "export async function getUserDetail" src/lib/actions/admin.ts
grep -l "/admin/:path" middleware.ts
```
</verification>

<success_criteria>
- src/config/admin.ts exports isAdmin and ADMIN_EMAILS
- src/lib/hooks/use-debounce.ts exports useDebounce
- src/lib/actions/admin.ts exports getAllUsers and getUserDetail
- middleware.ts includes /admin/:path* in matcher and checks isAdmin
- All server actions verify admin status before returning data
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-dashboard-users/03-01-SUMMARY.md`
</output>
