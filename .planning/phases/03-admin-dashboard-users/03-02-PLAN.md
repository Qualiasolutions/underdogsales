---
phase: 03-admin-dashboard-users
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/admin/layout.tsx
  - src/app/admin/page.tsx
  - src/app/admin/users/page.tsx
  - src/app/admin/users/[userId]/page.tsx
  - src/components/admin/AdminNav.tsx
  - src/components/admin/UserTable.tsx
  - src/components/admin/UserRow.tsx
  - src/components/admin/SearchFilter.tsx
  - src/components/admin/UserDetailCard.tsx
  - src/components/admin/Pagination.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access /admin only if their email is in whitelist"
    - "Admin can view all users in a searchable, paginated table"
    - "Admin can click a user to see their full activity detail"
    - "Non-admins are redirected away from /admin"
    - "Search filters users by email or name"
    - "Pagination uses URL-based state (bookmarkable)"
  artifacts:
    - path: "src/app/admin/layout.tsx"
      provides: "Admin layout with navigation"
      min_lines: 25
    - path: "src/app/admin/users/page.tsx"
      provides: "User list page with search and pagination"
      min_lines: 40
    - path: "src/app/admin/users/[userId]/page.tsx"
      provides: "User detail page"
      min_lines: 30
    - path: "src/components/admin/UserTable.tsx"
      provides: "User list table component"
      min_lines: 50
    - path: "src/components/admin/SearchFilter.tsx"
      provides: "Search input with debounce"
      min_lines: 30
  key_links:
    - from: "src/app/admin/users/page.tsx"
      to: "src/lib/actions/admin.ts"
      via: "getAllUsers server action call"
      pattern: "getAllUsers"
    - from: "src/app/admin/users/[userId]/page.tsx"
      to: "src/lib/actions/admin.ts"
      via: "getUserDetail server action call"
      pattern: "getUserDetail"
    - from: "src/components/admin/SearchFilter.tsx"
      to: "src/lib/hooks/use-debounce.ts"
      via: "useDebounce hook call"
      pattern: "useDebounce"
---

<objective>
Build admin layout and user management interface.

Purpose: Admins can view all platform users with activity metrics, search, and see user details.
Output: Admin layout with nav, user list page with table, user detail page, supporting components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-dashboard-users/03-CONTEXT.md
@.planning/phases/03-admin-dashboard-users/03-RESEARCH.md
@.planning/phases/03-admin-dashboard-users/03-01-SUMMARY.md

# Server actions from Plan 01
@src/lib/actions/admin.ts
@src/config/admin.ts
@src/lib/hooks/use-debounce.ts

# Existing components for patterns
@src/components/dashboard/DashboardClient.tsx (layout patterns)
@src/components/ui/header.tsx (navigation pattern)
@src/config/personas.ts (personas data for display)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout and navigation</name>
  <files>src/app/admin/layout.tsx, src/components/admin/AdminNav.tsx</files>
  <action>
    Create `src/components/admin/AdminNav.tsx`:

    - 'use client' directive (for active state)
    - Import Link from 'next/link'
    - Import usePathname from 'next/navigation'
    - Import icons: Users, FileText, Home, LayoutDashboard from lucide-react
    - Import cn from @/lib/utils

    Props: none (reads pathname internally)

    Navigation items:
    - Dashboard (/admin) - LayoutDashboard icon
    - Users (/admin/users) - Users icon
    - Content (/admin/content) - FileText icon
    - Back to App (/) - Home icon

    Component behavior:
    - Vertical sidebar with navy background
    - White text, gold highlight on active link
    - Active state based on pathname.startsWith()
    - Fixed width (w-64), full height (min-h-screen)
    - Logo/title at top: "Admin Panel"

    ---

    Create `src/app/admin/layout.tsx`:

    - Server component (no 'use client')
    - Import AdminNav from @/components/admin/AdminNav
    - Import Header from @/components/ui/header (optional, or custom admin header)

    Structure:
    ```tsx
    export default function AdminLayout({ children }: { children: React.ReactNode }) {
      return (
        <div className="flex min-h-screen bg-gray-50">
          <AdminNav />
          <main className="flex-1 p-8 overflow-auto">
            {children}
          </main>
        </div>
      )
    }
    ```

    Note: Auth is handled by middleware, no need for layout-level auth check.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Admin layout renders with sidebar navigation</done>
</task>

<task type="auto">
  <name>Task 2: Create admin dashboard overview page</name>
  <files>src/app/admin/page.tsx</files>
  <action>
    Create `src/app/admin/page.tsx`:

    - Server component
    - Import Link from 'next/link'
    - Import Users, FileText, TrendingUp from lucide-react
    - Import getAllUsers from @/lib/actions/admin

    Page behavior:
    - Show quick stats cards (total users, active this week, etc.)
    - Show quick links to Users and Content sections
    - Keep it simple - this is an overview page

    Stats to fetch:
    - Total user count (from getAllUsers with limit: 0 just for count, or add separate action)

    Layout:
    ```tsx
    <div>
      <h1 className="text-3xl font-bold text-navy mb-8">Admin Dashboard</h1>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <StatCard title="Total Users" value={userCount} icon={Users} />
        <StatCard title="Practice Sessions" value="Coming soon" icon={TrendingUp} />
        <StatCard title="Content Items" value={personaCount} icon={FileText} />
      </div>

      {/* Quick Links */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <QuickLinkCard
          title="User Management"
          description="View and manage all platform users"
          href="/admin/users"
          icon={Users}
        />
        <QuickLinkCard
          title="Content Management"
          description="View personas and scoring rubric"
          href="/admin/content"
          icon={FileText}
        />
      </div>
    </div>
    ```

    Create inline StatCard and QuickLinkCard components (simple, no need for separate files).
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Admin dashboard shows overview with stats and quick links</done>
</task>

<task type="auto">
  <name>Task 3: Create SearchFilter and Pagination components</name>
  <files>src/components/admin/SearchFilter.tsx, src/components/admin/Pagination.tsx</files>
  <action>
    Create `src/components/admin/SearchFilter.tsx`:

    - 'use client' directive
    - Import useRouter, usePathname, useSearchParams from 'next/navigation'
    - Import useState, useTransition, useEffect from 'react'
    - Import Search, Loader2, X from lucide-react
    - Import useDebounce from '@/lib/hooks/use-debounce'
    - Import cn from '@/lib/utils'

    Props:
    ```typescript
    interface SearchFilterProps {
      defaultSearch?: string
      placeholder?: string
      className?: string
    }
    ```

    Component behavior:
    - Controlled input with local state
    - Debounce value by 300ms
    - On debounced value change, update URL with search param
    - Reset to page 1 when search changes
    - Show loading spinner during transition
    - Clear button when search has value

    ---

    Create `src/components/admin/Pagination.tsx`:

    - 'use client' directive
    - Import Link from 'next/link'
    - Import usePathname, useSearchParams from 'next/navigation'
    - Import ChevronLeft, ChevronRight from lucide-react'
    - Import cn from '@/lib/utils'

    Props:
    ```typescript
    interface PaginationProps {
      currentPage: number
      hasMore: boolean
      className?: string
    }
    ```

    Component behavior:
    - Previous button (disabled on page 1)
    - Page number display: "Page X"
    - Next button (disabled when !hasMore)
    - Links preserve existing search params
    - Update 'page' param in URL
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>SearchFilter debounces and updates URL, Pagination navigates via URL</done>
</task>

<task type="auto">
  <name>Task 4: Create UserTable and UserRow components</name>
  <files>src/components/admin/UserTable.tsx, src/components/admin/UserRow.tsx</files>
  <action>
    Create `src/components/admin/UserRow.tsx`:

    - 'use client' directive (for hover state)
    - Import Link from 'next/link'
    - Import type AdminUser from '@/lib/actions/admin'
    - Import cn from '@/lib/utils'
    - Import ChevronRight from lucide-react

    Props:
    ```typescript
    interface UserRowProps {
      user: AdminUser
    }
    ```

    Component behavior:
    - Table row with clickable link to /admin/users/[userId]
    - Columns: Name, Email, Sessions, Avg Score, Last Active, Joined
    - Format dates as "Jan 15, 2026"
    - Show score with color coding (green >= 7, yellow 5-7, red < 5)
    - Hover state: subtle background change
    - ChevronRight icon on right side

    ---

    Create `src/components/admin/UserTable.tsx`:

    - Server component (no 'use client')
    - Import UserRow from './UserRow'
    - Import type AdminUser from '@/lib/actions/admin'
    - Import cn from '@/lib/utils'

    Props:
    ```typescript
    interface UserTableProps {
      users: AdminUser[]
      className?: string
    }
    ```

    Component behavior:
    - Native HTML table with Tailwind styling
    - Header row with column names
    - Map users to UserRow components
    - Empty state if users.length === 0: "No users found"
    - Responsive: horizontal scroll on mobile

    Table columns:
    | User | Email | Sessions | Avg Score | Last Active | Joined |
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>UserTable renders users with clickable rows linking to detail</done>
</task>

<task type="auto">
  <name>Task 5: Create users list page</name>
  <files>src/app/admin/users/page.tsx</files>
  <action>
    Create `src/app/admin/users/page.tsx`:

    - Server component
    - Import getAllUsers from '@/lib/actions/admin'
    - Import UserTable from '@/components/admin/UserTable'
    - Import SearchFilter from '@/components/admin/SearchFilter'
    - Import Pagination from '@/components/admin/Pagination'

    Props:
    ```typescript
    interface Props {
      searchParams: Promise<{ search?: string; page?: string }>
    }
    ```

    export const dynamic = 'force-dynamic'

    Component behavior:
    - Await searchParams (Next.js 15+ pattern)
    - Extract search and page from params
    - Calculate offset from page (limit = 20)
    - Call getAllUsers with options
    - Render SearchFilter, UserTable, Pagination

    Layout:
    ```tsx
    <div>
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold text-navy">Users</h1>
        <span className="text-muted-foreground">{total} total</span>
      </div>

      <SearchFilter defaultSearch={search} placeholder="Search by name or email..." />

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        <UserTable users={users} />
      </div>

      <Pagination currentPage={page} hasMore={hasMore} />
    </div>
    ```

    Handle error state: show error message if getAllUsers returns error.
  </action>
  <verify>
    npx tsc --noEmit && npm run build
    grep "getAllUsers" src/app/admin/users/page.tsx
  </verify>
  <done>Users page renders searchable, paginated user table and calls getAllUsers</done>
</task>

<task type="auto">
  <name>Task 6: Create UserDetailCard and user detail page</name>
  <files>src/components/admin/UserDetailCard.tsx, src/app/admin/users/[userId]/page.tsx</files>
  <action>
    Create `src/components/admin/UserDetailCard.tsx`:

    - Server component
    - Import type AdminUser, AdminSession from '@/lib/actions/admin'
    - Import getScoreLabel, getScoreColor from '@/config/rubric'
    - Import { PERSONAS } from '@/config/personas'
    - Import cn from '@/lib/utils'
    - Import Mail, Calendar, Clock, Target from lucide-react

    Props:
    ```typescript
    interface UserDetailCardProps {
      user: AdminUser
      sessions: AdminSession[]
    }
    ```

    Component behavior:
    - Header section: user name, email, role badge
    - Stats row: total sessions, average score, member since
    - Session history list (most recent first)
    - Each session shows: persona name, scenario, date, duration, overall score
    - Expandable session detail showing dimension scores

    ---

    Create `src/app/admin/users/[userId]/page.tsx`:

    - Server component
    - Import getUserDetail from '@/lib/actions/admin'
    - Import UserDetailCard from '@/components/admin/UserDetailCard'
    - Import Link from 'next/link'
    - Import ArrowLeft from 'lucide-react'
    - Import notFound from 'next/navigation'

    Props:
    ```typescript
    interface Props {
      params: Promise<{ userId: string }>
    }
    ```

    export const dynamic = 'force-dynamic'

    Component behavior:
    - Await params, extract userId
    - Call getUserDetail(userId)
    - If error or no user, call notFound()
    - Render back link to /admin/users
    - Render UserDetailCard with user and sessions

    Layout:
    ```tsx
    <div>
      <Link href="/admin/users" className="inline-flex items-center text-muted-foreground hover:text-navy mb-6">
        <ArrowLeft className="w-4 h-4 mr-2" />
        Back to Users
      </Link>

      <UserDetailCard user={user} sessions={sessions} />
    </div>
    ```
  </action>
  <verify>npx tsc --noEmit && npm run build</verify>
  <done>User detail page shows full user info and session history</done>
</task>

</tasks>

<verification>
```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Verify pages exist
ls -la src/app/admin/
ls -la src/app/admin/users/
ls -la src/app/admin/users/\[userId\]/

# Verify components exist
ls -la src/components/admin/
```
</verification>

<success_criteria>
- Admin layout renders with sidebar navigation
- Admin dashboard shows overview with quick links
- Users page shows searchable, paginated user table
- User detail page shows user info and session history
- Search updates URL and filters results
- Pagination uses URL-based state
- All pages work with TypeScript
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-dashboard-users/03-02-SUMMARY.md`
</output>
