---
phase: 05-technical-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ARCHITECTURE.md
  - docs/DATABASE.md
autonomous: true

must_haves:
  truths:
    - "Developer can understand system architecture from documentation"
    - "Developer can find any database table schema"
    - "Developer can understand data flow for key features"
  artifacts:
    - path: "docs/ARCHITECTURE.md"
      provides: "System overview, component diagram, data flows"
      min_lines: 150
    - path: "docs/DATABASE.md"
      provides: "All tables, columns, RLS policies, functions"
      min_lines: 200
  key_links:
    - from: "docs/ARCHITECTURE.md"
      to: "docs/DATABASE.md"
      via: "Cross-references to database documentation"
      pattern: "DATABASE\\.md"
---

<objective>
Create architecture and database documentation for the Underdog AI Sales Coach platform.

Purpose: Enable new developers to understand system design and database schema without reading source code.
Output: Two comprehensive documentation files covering system architecture and database schema.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-technical-documentation/05-RESEARCH.md

# Source files to extract from
@CLAUDE.md
@src/lib/supabase/types.ts
@supabase/migrations/001_initial_schema.sql
@supabase/migrations/002_knowledge_base.sql
@supabase/migrations/003_call_uploads_status.sql
@supabase/migrations/004_audit_log.sql
@supabase/migrations/005_soft_delete.sql
@supabase/migrations/009_consolidate_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Architecture Documentation</name>
  <files>docs/ARCHITECTURE.md</files>
  <action>
Create `docs/ARCHITECTURE.md` with the following structure:

1. **System Overview**
   - Brief description (AI-powered sales training platform)
   - Core value proposition
   - Tech stack summary (Next.js 16, React 19, Supabase, VAPI, OpenRouter)

2. **Architecture Diagram** (Mermaid flowchart)
   - Client layer: React UI, VAPI Web SDK
   - API layer: Next.js API routes (chat, webhook, analyze, health)
   - External services: OpenRouter LLM, VAPI Cloud, OpenAI Whisper
   - Data layer: Supabase (Auth, PostgreSQL, Storage)

3. **Component Responsibilities**
   - `/src/app/` - Page routes and API handlers
   - `/src/components/` - React components by feature
   - `/src/config/` - Personas, rubric, curriculum, coach
   - `/src/lib/` - Utilities and integrations

4. **Key Data Flows** (3 Mermaid sequence diagrams)
   - Voice Practice Flow: User → VAPI → Webhook → Database
   - Call Analysis Flow: Upload → Transcribe → Score → Stream
   - Chat Coaching Flow: Message → RAG Search → LLM → Response

5. **Technology Decisions**
   - Why VAPI (managed voice infrastructure)
   - Why OpenRouter (multi-model access, cost control)
   - Why Supabase (auth + db + storage + RLS)
   - Why pgvector (semantic search for RAG)

Extract actual flow logic from CLAUDE.md and route files, not invented examples.
  </action>
  <verify>
File exists at `docs/ARCHITECTURE.md`, contains Mermaid diagrams (check for "```mermaid"), has all 5 sections.
  </verify>
  <done>
ARCHITECTURE.md covers system overview, diagram, components, 3 data flows, and technology rationale.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Database Documentation</name>
  <files>docs/DATABASE.md</files>
  <action>
Create `docs/DATABASE.md` with the following structure:

1. **Overview**
   - Database: PostgreSQL via Supabase
   - Extensions: pgvector (for embeddings)
   - Soft delete pattern: `deleted_at` column

2. **Schema Diagram** (Mermaid ER diagram)
   - Show relationships between users, sessions, scores, uploads

3. **Tables** (document each table with this format):
   - Table name and description
   - Columns table: Column | Type | Nullable | Description
   - RLS Policies (extracted from migration 009)

   Tables to document:
   - `users` (synced from auth.users)
   - `roleplay_sessions` (voice practice records)
   - `session_scores` (6-dimension scoring)
   - `call_uploads` (uploaded recordings)
   - `curriculum_progress` (module completion)
   - `knowledge_base` (RAG chunks + embeddings)
   - `objections_kb` (objection handling data)
   - `audit_log` (security audit trail)

4. **Stored Functions**
   - `match_knowledge(query_embedding, match_count)` - RAG search
   - `match_objections(query_embedding, match_count)` - Objection lookup
   - `soft_delete_user()` - User deletion trigger

5. **Storage Buckets**
   - `call-recordings` - Audio files for analysis
   - Policies: authenticated users can upload/read own files

Extract schemas from `src/lib/supabase/types.ts` and migrations. Use actual column names and types.
  </action>
  <verify>
File exists at `docs/DATABASE.md`, documents all 8 tables, includes RLS policy descriptions for each table.
  </verify>
  <done>
DATABASE.md covers all tables with columns, types, RLS policies, stored functions, and storage buckets.
  </done>
</task>

</tasks>

<verification>
1. Both files exist in `docs/` directory
2. ARCHITECTURE.md has at least 3 Mermaid diagrams
3. DATABASE.md documents all 8 tables
4. Cross-references between docs work (links are correct)
5. `npm run build` still passes (no broken imports)
</verification>

<success_criteria>
- [ ] docs/ARCHITECTURE.md exists with system overview and data flow diagrams
- [ ] docs/DATABASE.md exists with all table schemas and RLS policies
- [ ] Documentation is accurate (matches actual codebase structure)
- [ ] Mermaid diagrams render correctly in GitHub preview
</success_criteria>

<output>
After completion, create `.planning/phases/05-technical-documentation/05-01-SUMMARY.md`
</output>
