---
phase: 05-technical-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/API.md
autonomous: true

must_haves:
  truths:
    - "Developer can find documentation for any API endpoint"
    - "Developer knows authentication requirements for each endpoint"
    - "Developer understands request/response schemas"
  artifacts:
    - path: "docs/API.md"
      provides: "All 12 API endpoints with schemas, auth, errors"
      min_lines: 300
  key_links:
    - from: "docs/API.md"
      to: "src/app/api/**/*.ts"
      via: "Endpoint paths match route file locations"
      pattern: "/api/"
---

<objective>
Create comprehensive API reference documentation for all Next.js API routes.

Purpose: Enable developers to integrate with and maintain API endpoints without reading source code.
Output: Single API reference document covering all 12 endpoints with request/response schemas.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-technical-documentation/05-RESEARCH.md

# API Route files to document
@src/app/api/chat/route.ts
@src/app/api/health/route.ts
@src/app/api/vapi/webhook/route.ts
@src/app/api/vapi/tools/knowledge-base/route.ts
@src/app/api/knowledge/search/route.ts
@src/app/api/analyze/upload/route.ts
@src/app/api/analyze/transcribe/route.ts
@src/app/api/analyze/score/route.ts
@src/app/api/analyze/[callId]/route.ts
@src/app/api/analyze/[callId]/stream/route.ts
@src/app/api/user/delete/route.ts
@src/app/api/user/export/route.ts

# Supporting files for validation schemas and errors
@src/lib/validations.ts
@src/lib/errors.ts
@src/lib/rate-limit.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API Reference Documentation</name>
  <files>docs/API.md</files>
  <action>
Create `docs/API.md` with comprehensive documentation for all API endpoints.

**Structure:**

1. **Overview**
   - Base URL: `https://under-eight.vercel.app` (production)
   - Authentication: Supabase Auth (JWT in Authorization header)
   - Rate limiting: Per-endpoint limits (see each endpoint)
   - Error format: `{ error: string }` with appropriate HTTP status

2. **Endpoints by Category**

**Chat & Coaching:**
- `POST /api/chat` - Chat with AI sales coach (RAG-enhanced)
  - Auth: Required
  - Body: `{ messages: Array<{role, content}>, mode?: string }`
  - Response: `{ message: string }`
  - Errors: 401, 429, 503 (circuit breaker)

**Voice Practice (VAPI):**
- `POST /api/vapi/webhook` - VAPI event webhook
  - Auth: HMAC signature verification (VAPI_WEBHOOK_SECRET)
  - Body: VAPI event payload
  - Response: 200 OK or config response
  - Errors: 401 (invalid signature)

- `POST /api/vapi/tools/knowledge-base` - VAPI tool call handler
  - Auth: None (called by VAPI)
  - Body: VAPI tool call payload
  - Response: Knowledge base search results

**Knowledge Base:**
- `POST /api/knowledge/search` - Semantic search for RAG
  - Auth: Required
  - Body: `{ query: string, matchCount?: number }`
  - Response: `{ results: Array<{content, similarity}> }`

**Call Analysis:**
- `POST /api/analyze/upload` - Upload audio for analysis
  - Auth: Required
  - Body: FormData with audio file
  - Limits: 100MB max, audio/* types
  - Response: `{ callId: string }`

- `POST /api/analyze/transcribe` - Transcribe uploaded audio
  - Auth: Required
  - Body: `{ callId: string }`
  - Response: `{ transcript: string }`

- `POST /api/analyze/score` - Score transcribed call
  - Auth: Required
  - Body: `{ callId: string }`
  - Response: `{ scores: SessionScore }`

- `GET /api/analyze/[callId]` - Get analysis details
  - Auth: Required
  - Response: `{ upload: CallUpload, scores?: SessionScore }`

- `GET /api/analyze/[callId]/stream` - Stream analysis progress
  - Auth: Required
  - Response: Server-Sent Events stream

**User Management:**
- `DELETE /api/user/delete` - Delete user account (GDPR)
  - Auth: Required
  - Response: 204 No Content

- `GET /api/user/export` - Export user data (GDPR)
  - Auth: Required
  - Response: JSON export of all user data

**Health:**
- `GET /api/health` - Health check endpoint
  - Auth: None
  - Response: `{ status, services: { supabase, openai, openrouter } }`

**For each endpoint, include:**
- HTTP method and path
- Description (1 sentence)
- Authentication requirement
- Request body schema (table format)
- Response schema (table format)
- Error responses (table: status, error, description)
- Rate limit (if applicable)

Extract actual schemas from route files and `src/lib/validations.ts`.
  </action>
  <verify>
File exists at `docs/API.md`, documents all 12 endpoints, each has method/path/auth/body/response/errors.
  </verify>
  <done>
API.md covers all 12 API endpoints with complete request/response documentation and error codes.
  </done>
</task>

</tasks>

<verification>
1. `docs/API.md` exists with 12 documented endpoints
2. Each endpoint has: method, path, auth, request, response, errors
3. Schemas match actual TypeScript types in source
4. Rate limits documented where applicable
5. `npm run build` still passes
</verification>

<success_criteria>
- [ ] docs/API.md exists with all 12 API endpoints documented
- [ ] Each endpoint has authentication requirements specified
- [ ] Request/response schemas are in table format
- [ ] Error responses are documented with status codes
- [ ] Documentation matches actual API behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05-technical-documentation/05-02-SUMMARY.md`
</output>
