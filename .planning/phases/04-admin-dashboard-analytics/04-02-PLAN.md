---
phase: 04-admin-dashboard-analytics
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/actions/admin.ts
  - src/components/admin/UsageCharts.tsx
  - src/components/admin/SystemHealth.tsx
  - src/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see sessions/calls over time chart"
    - "Admin can see system health status for Supabase, OpenAI, OpenRouter"
    - "Admin can see circuit breaker states"
    - "Charts handle empty data gracefully"
  artifacts:
    - path: "src/lib/actions/admin.ts"
      provides: "getSystemHealth server action"
      exports: ["getSystemHealth"]
    - path: "src/components/admin/UsageCharts.tsx"
      provides: "Usage trend charts"
      contains: "'use client'"
      min_lines: 50
    - path: "src/components/admin/SystemHealth.tsx"
      provides: "System health display"
      min_lines: 40
  key_links:
    - from: "src/components/admin/UsageCharts.tsx"
      to: "recharts"
      via: "import"
      pattern: "from 'recharts'"
    - from: "src/app/admin/analytics/page.tsx"
      to: "UsageCharts"
      via: "component import"
      pattern: "UsageCharts"
    - from: "src/components/admin/SystemHealth.tsx"
      to: "getSystemHealth"
      via: "server action"
      pattern: "getSystemHealth"
---

<objective>
Add usage charts and system health monitoring to analytics dashboard.

Purpose: Visualize platform activity trends and service health status
Output: AreaChart for usage over time, system health panel with service status and circuit breakers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-admin-dashboard-analytics/04-RESEARCH.md
@.planning/phases/04-admin-dashboard-analytics/04-01-SUMMARY.md

# Existing patterns
@src/components/dashboard/progress/ScoreTrendChart.tsx
@src/app/api/health/route.ts
@src/lib/circuit-breaker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UsageCharts component</name>
  <files>src/components/admin/UsageCharts.tsx</files>
  <action>
Create 'use client' component for usage charts using Recharts AreaChart.

Props:
- data: DailyMetric[] (from getAnalyticsData)

Follow ScoreTrendChart.tsx pattern:
1. Import AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer from recharts
2. Handle empty data with centered message: "No activity data yet."
3. Use ResponsiveContainer with height={300}
4. AreaChart with margin: { top: 10, right: 10, left: -10, bottom: 0 }
5. CartesianGrid with strokeDasharray="3 3" and className="stroke-muted"
6. XAxis on "date" dataKey, YAxis with auto domain
7. Tooltip with dark background style matching ScoreTrendChart
8. Two Area elements:
   - sessions: stroke="var(--underdog-navy)", fill="var(--underdog-navy)", fillOpacity={0.3}
   - calls: stroke="var(--underdog-gold)", fill="var(--underdog-gold)", fillOpacity={0.3}

Wrap in Card-like container:
- bg-white rounded-xl p-6 shadow-sm border
- h3 header: "Activity Trend" with font-semibold text-navy mb-4
- Legend below chart showing color indicators for Sessions and Calls

Import DailyMetric type from @/lib/actions/admin.
  </action>
  <verify>Component file exists with 'use client' directive and recharts imports</verify>
  <done>UsageCharts renders AreaChart with sessions and calls data, handles empty state</done>
</task>

<task type="auto">
  <name>Task 2: Add getSystemHealth server action</name>
  <files>src/lib/actions/admin.ts</files>
  <action>
Add getSystemHealth server action to admin.ts.

The function should:
1. Verify admin access using existing pattern
2. Fetch health data from /api/health endpoint:
   - Use NEXT_PUBLIC_SITE_URL for base URL (handle localhost fallback)
   - Add cache: 'no-store' to prevent caching
   - Add timeout of 5 seconds using AbortSignal.timeout
3. Get circuit breaker stats from imported circuit breakers:
   - Import openaiCircuit, openrouterCircuit, vapiCircuit, supabaseCircuit from @/lib/circuit-breaker
   - Call getStats() on each
4. Return combined result:

```typescript
interface SystemHealthResult {
  health: {
    status: 'healthy' | 'unhealthy' | 'degraded'
    timestamp: string
    uptime: number
    services: {
      supabase: { status: string; latency?: number; error?: string }
      openai: { status: string; latency?: number; error?: string }
      openrouter: { status: string; latency?: number; error?: string }
    }
  } | null
  circuitBreakers: Array<{
    name: string
    state: string
    failures: number
    totalRequests: number
  }>
  error: string | null
}
```

Handle fetch errors gracefully - return partial data with error message.
  </action>
  <verify>TypeScript compiles without errors: `npm run typecheck`</verify>
  <done>getSystemHealth returns health data and circuit breaker stats</done>
</task>

<task type="auto">
  <name>Task 3: Create SystemHealth component and update analytics page</name>
  <files>src/components/admin/SystemHealth.tsx, src/app/admin/analytics/page.tsx</files>
  <action>
1. Create SystemHealth server component:
   - Import getSystemHealth from @/lib/actions/admin
   - Call getSystemHealth() and display results
   - Layout:
     - bg-white rounded-xl p-6 shadow-sm border
     - h3 "System Health" with font-semibold text-navy mb-4
   - Services section:
     - Each service as row with name and status badge
     - Badge colors: healthy=green (bg-green-100 text-green-800), unhealthy=red, degraded=yellow
     - Show latency in parentheses if available
   - Circuit Breakers section (mt-4 pt-4 border-t):
     - Label "Circuit Breakers" in text-sm text-muted-foreground
     - Each breaker: name + state colored (closed=green, open=red, half-open=yellow)
   - Handle error case with error message

2. Update analytics page:
   - Import UsageCharts and SystemHealth
   - Add grid layout below MetricsCards: grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6
   - UsageCharts in lg:col-span-2
   - SystemHealth in remaining column
   - Pass dailyData from getAnalyticsData to UsageCharts
  </action>
  <verify>
1. Navigate to /admin/analytics
2. See usage chart with two colored areas
3. See system health panel with service statuses
4. See circuit breaker states
  </verify>
  <done>Analytics page shows charts and system health, all ADMIN-02 and ADMIN-03 requirements met</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run lint` passes
3. `npm run build` succeeds
4. Navigate to /admin/analytics as admin
5. See usage trend chart (or empty state if no data)
6. See system health with Supabase, OpenAI, OpenRouter status
7. See circuit breaker states (all should be "closed" normally)
8. Chart shows legend for Sessions and Calls
</verification>

<success_criteria>
- UsageCharts displays AreaChart with sessions and calls trends
- Empty data shows helpful message instead of crash
- SystemHealth shows service status with colored badges
- Circuit breakers display with state indicators
- All Phase 4 requirements (ADMIN-02, ADMIN-03) are met
- Page loads in <3s (no blocking health check)
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-dashboard-analytics/04-02-SUMMARY.md`
</output>
