---
phase: 04-admin-dashboard-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/admin.ts
  - src/components/admin/MetricsCards.tsx
  - src/components/admin/AdminNav.tsx
  - src/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see total practice sessions count"
    - "Admin can see total calls analyzed count"
    - "Admin can see active users count (last 30 days)"
    - "Admin can access analytics page from navigation"
  artifacts:
    - path: "src/lib/actions/admin.ts"
      provides: "getAnalyticsData server action"
      exports: ["getAnalyticsData"]
    - path: "src/components/admin/MetricsCards.tsx"
      provides: "Metrics display component"
      min_lines: 40
    - path: "src/app/admin/analytics/page.tsx"
      provides: "Analytics page"
      min_lines: 20
  key_links:
    - from: "src/app/admin/analytics/page.tsx"
      to: "getAnalyticsData"
      via: "server action call"
      pattern: "getAnalyticsData"
    - from: "src/app/admin/analytics/page.tsx"
      to: "MetricsCards"
      via: "component import"
      pattern: "MetricsCards"
---

<objective>
Create analytics data layer and metrics display for admin dashboard.

Purpose: Provide admins with key platform usage metrics at a glance
Output: Server action for analytics data, MetricsCards component, analytics page with navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-admin-dashboard-analytics/04-RESEARCH.md

# Existing patterns
@src/lib/actions/admin.ts
@src/components/admin/AdminNav.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAnalyticsData server action</name>
  <files>src/lib/actions/admin.ts</files>
  <action>
Add getAnalyticsData server action to existing admin.ts file. Follow the existing pattern of admin verification.

The function should:
1. Accept optional `days` parameter (default 30)
2. Verify admin access using existing pattern
3. Query roleplay_sessions for period (filter deleted_at is null)
4. Query call_uploads for period (filter deleted_at is null)
5. Count unique user_ids from sessions for active users
6. Group data by day using toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
7. Return: { metrics: { totalSessions, totalCalls, activeUsers, dailyData }, error: null }

Interface for dailyData:
```typescript
interface DailyMetric {
  date: string  // "Jan 15"
  sessions: number
  calls: number
}
```

Export the DailyMetric interface.

Use groupByDay helper function (keep it private, not exported). Sort by date ascending for chart display.
  </action>
  <verify>TypeScript compiles without errors: `npm run typecheck`</verify>
  <done>getAnalyticsData server action exists, returns correct shape, handles errors gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Create MetricsCards component</name>
  <files>src/components/admin/MetricsCards.tsx</files>
  <action>
Create server component displaying key metrics in a grid of cards.

Props:
- totalSessions: number
- totalCalls: number
- activeUsers: number

Layout:
- 3-column grid on desktop (grid-cols-3), 1-column on mobile
- Each card: bg-white, rounded-xl, shadow-sm, border, p-6
- Icon in colored circle (bg-navy/10 or similar)
- Metric value large and bold
- Label below in muted text

Use lucide-react icons:
- MessageSquare for sessions
- Phone for calls
- Users for active users

Format numbers with Intl.NumberFormat for readability (locale 'en-US').

No 'use client' needed - pure server component receiving props.
  </action>
  <verify>Component file exists and exports MetricsCards</verify>
  <done>MetricsCards displays 3 metric cards with icons, formatted values, and responsive layout</done>
</task>

<task type="auto">
  <name>Task 3: Create analytics page and update navigation</name>
  <files>src/app/admin/analytics/page.tsx, src/components/admin/AdminNav.tsx</files>
  <action>
1. Create analytics page (server component):
   - Import getAnalyticsData from @/lib/actions/admin
   - Import MetricsCards from @/components/admin/MetricsCards
   - Call getAnalyticsData() and destructure metrics
   - Handle error case with error message display
   - Render page with:
     - h1 "Analytics" with text-2xl font-bold text-navy
     - Subtitle "Platform usage and system health" in muted text
     - MetricsCards with spread metrics (totalSessions, totalCalls, activeUsers)
     - Placeholder div for charts (will be added in Plan 02)

2. Update AdminNav:
   - Add BarChart3 icon import from lucide-react
   - Add analytics nav item after Dashboard:
     ```
     { href: '/admin/analytics', label: 'Analytics', icon: BarChart3 }
     ```
  </action>
  <verify>
1. Navigate to /admin/analytics (as admin user)
2. See Analytics heading and 3 metric cards
3. Navigation shows Analytics link with chart icon
  </verify>
  <done>Analytics page displays metrics, nav includes Analytics link</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run lint` passes
3. Navigate to /admin/analytics as admin user
4. See 3 metric cards with session count, call count, active users
5. Numbers are formatted (e.g., "1,234" not "1234")
6. Navigation includes Analytics link between Dashboard and Users
</verification>

<success_criteria>
- getAnalyticsData returns { totalSessions, totalCalls, activeUsers, dailyData }
- MetricsCards displays formatted metrics in responsive grid
- Analytics page accessible at /admin/analytics
- Admin navigation updated with Analytics link
- All metrics show real data from database (or 0 if empty)
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-dashboard-analytics/04-01-SUMMARY.md`
</output>
