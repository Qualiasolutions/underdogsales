# Production Audit Fix Plan

**Project:** Underdog AI Sales Coach
**Audit Date:** 2026-01-19
**Current Score:** 52/100
**Target Score:** 85+/100

---

## Phase 1: Critical Security & Error Handling (BLOCKERS)

### 1.1 Add Security Headers
**File:** `next.config.ts`
**Priority:** P0 - BLOCKER

```typescript
// Add to next.config.ts
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        { key: 'X-Frame-Options', value: 'DENY' },
        { key: 'X-Content-Type-Options', value: 'nosniff' },
        { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
        { key: 'X-XSS-Protection', value: '1; mode=block' },
        { key: 'Strict-Transport-Security', value: 'max-age=31536000; includeSubDomains' },
        {
          key: 'Content-Security-Policy',
          value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.vapi.ai; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.vapi.ai https://api.openai.com https://openrouter.ai; media-src 'self' blob:; frame-ancestors 'none';"
        },
      ],
    },
  ]
}
```

### 1.2 Create Error Boundaries
**Files to create:**

#### `src/app/error.tsx`
```typescript
'use client'

import { useEffect } from 'react'
import { Button } from '@/components/ui/button'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    // Log to error tracking service (Sentry)
    console.error('Application error:', error)
  }, [error])

  return (
    <div className="flex min-h-screen flex-col items-center justify-center gap-4">
      <h2 className="text-2xl font-bold">Something went wrong</h2>
      <p className="text-muted-foreground">
        We encountered an unexpected error. Please try again.
      </p>
      <Button onClick={reset}>Try again</Button>
    </div>
  )
}
```

#### `src/app/global-error.tsx`
```typescript
'use client'

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <html>
      <body>
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh',
          gap: '1rem'
        }}>
          <h2>Something went wrong</h2>
          <button onClick={reset}>Try again</button>
        </div>
      </body>
    </html>
  )
}
```

#### `src/app/not-found.tsx`
```typescript
import Link from 'next/link'
import { Button } from '@/components/ui/button'

export default function NotFound() {
  return (
    <div className="flex min-h-screen flex-col items-center justify-center gap-4">
      <h2 className="text-4xl font-bold">404</h2>
      <p className="text-muted-foreground">Page not found</p>
      <Button asChild>
        <Link href="/">Go home</Link>
      </Button>
    </div>
  )
}
```

### 1.3 Secure VAPI Webhook
**File:** `src/app/api/vapi/webhook/route.ts`
**Priority:** P0 - BLOCKER

```typescript
// Add at top of POST handler
import crypto from 'crypto'

function verifyVapiSignature(payload: string, signature: string, secret: string): boolean {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex')
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  )
}

export async function POST(request: NextRequest) {
  // Verify webhook signature
  const signature = request.headers.get('x-vapi-signature')
  const rawBody = await request.text()

  if (!signature || !process.env.VAPI_WEBHOOK_SECRET) {
    return NextResponse.json({ error: 'Missing signature' }, { status: 401 })
  }

  if (!verifyVapiSignature(rawBody, signature, process.env.VAPI_WEBHOOK_SECRET)) {
    return NextResponse.json({ error: 'Invalid signature' }, { status: 401 })
  }

  const payload = JSON.parse(rawBody)
  // ... rest of handler
}
```

### 1.4 Secure Knowledge Search Endpoint
**File:** `src/app/api/knowledge/search/route.ts`
**Priority:** P0 - BLOCKER

```typescript
// Add after imports
import { getUser } from '@/lib/supabase/server'

export async function POST(request: NextRequest) {
  try {
    // Add authentication check
    const user = await getUser()
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // ... rest of handler
  }
}
```

### 1.5 Delete Duplicate Middleware
**Action:** Delete `/middleware.ts` (root), keep `/src/middleware.ts`

---

## Phase 2: Observability Infrastructure

### 2.1 Install Sentry
**Priority:** P0 - BLOCKER

```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

#### `sentry.client.config.ts`
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
  integrations: [
    Sentry.replayIntegration(),
  ],
})
```

#### `sentry.server.config.ts`
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
})
```

### 2.2 Add Structured Logging
**File:** `src/lib/logger.ts`

```typescript
type LogLevel = 'debug' | 'info' | 'warn' | 'error'

interface LogContext {
  requestId?: string
  userId?: string
  operation?: string
  duration?: number
  [key: string]: unknown
}

function log(level: LogLevel, message: string, context?: LogContext) {
  const entry = {
    timestamp: new Date().toISOString(),
    level,
    message,
    ...context,
  }

  if (process.env.NODE_ENV === 'production') {
    console[level](JSON.stringify(entry))
  } else {
    console[level](`[${level.toUpperCase()}] ${message}`, context)
  }
}

export const logger = {
  debug: (msg: string, ctx?: LogContext) => log('debug', msg, ctx),
  info: (msg: string, ctx?: LogContext) => log('info', msg, ctx),
  warn: (msg: string, ctx?: LogContext) => log('warn', msg, ctx),
  error: (msg: string, ctx?: LogContext) => log('error', msg, ctx),
}
```

### 2.3 Add Request ID Middleware
**File:** Update `src/middleware.ts`

```typescript
import { nanoid } from 'nanoid'

export async function middleware(request: NextRequest) {
  const requestId = request.headers.get('x-request-id') || nanoid()

  // Add to response headers
  const response = NextResponse.next()
  response.headers.set('x-request-id', requestId)

  // ... existing auth logic
}
```

### 2.4 Create Health Check Endpoint
**File:** `src/app/api/health/route.ts`

```typescript
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET() {
  const checks = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    services: {} as Record<string, { status: string; latency?: number }>
  }

  // Check Supabase
  const supabaseStart = Date.now()
  try {
    const supabase = await createClient()
    await supabase.from('organizations').select('id').limit(1)
    checks.services.supabase = {
      status: 'healthy',
      latency: Date.now() - supabaseStart
    }
  } catch {
    checks.services.supabase = { status: 'unhealthy' }
    checks.status = 'degraded'
  }

  // Check OpenAI
  try {
    const response = await fetch('https://api.openai.com/v1/models', {
      headers: { Authorization: `Bearer ${process.env.OPENAI_API_KEY}` },
      signal: AbortSignal.timeout(5000)
    })
    checks.services.openai = { status: response.ok ? 'healthy' : 'unhealthy' }
  } catch {
    checks.services.openai = { status: 'unhealthy' }
    checks.status = 'degraded'
  }

  const statusCode = checks.status === 'healthy' ? 200 : 503
  return NextResponse.json(checks, { status: statusCode })
}
```

### 2.5 Add Vercel Analytics
```bash
npm install @vercel/analytics @vercel/speed-insights
```

**File:** Update `src/app/layout.tsx`
```typescript
import { Analytics } from '@vercel/analytics/react'
import { SpeedInsights } from '@vercel/speed-insights/next'

// Add inside body, after children
<Analytics />
<SpeedInsights />
```

---

## Phase 3: Reliability Improvements

### 3.1 Implement Circuit Breaker
**File:** `src/lib/circuit-breaker.ts`

```typescript
type CircuitState = 'closed' | 'open' | 'half-open'

interface CircuitBreakerOptions {
  failureThreshold: number
  resetTimeout: number
  name: string
}

class CircuitBreaker {
  private state: CircuitState = 'closed'
  private failures = 0
  private lastFailure: number | null = null
  private options: CircuitBreakerOptions

  constructor(options: CircuitBreakerOptions) {
    this.options = options
  }

  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.state === 'open') {
      if (Date.now() - (this.lastFailure || 0) > this.options.resetTimeout) {
        this.state = 'half-open'
      } else {
        throw new Error(`Circuit breaker ${this.options.name} is open`)
      }
    }

    try {
      const result = await fn()
      this.onSuccess()
      return result
    } catch (error) {
      this.onFailure()
      throw error
    }
  }

  private onSuccess() {
    this.failures = 0
    this.state = 'closed'
  }

  private onFailure() {
    this.failures++
    this.lastFailure = Date.now()
    if (this.failures >= this.options.failureThreshold) {
      this.state = 'open'
    }
  }
}

export const openaiCircuit = new CircuitBreaker({
  name: 'openai',
  failureThreshold: 5,
  resetTimeout: 30000,
})

export const vapiCircuit = new CircuitBreaker({
  name: 'vapi',
  failureThreshold: 3,
  resetTimeout: 60000,
})
```

### 3.2 Add Database Retry Wrapper
**File:** Update `src/lib/supabase/server.ts`

```typescript
import { withRetry } from '@/lib/retry'

export async function queryWithRetry<T>(
  queryFn: () => Promise<{ data: T | null; error: Error | null }>
): Promise<T> {
  return withRetry(async () => {
    const { data, error } = await queryFn()
    if (error) throw error
    if (!data) throw new Error('No data returned')
    return data
  }, { maxAttempts: 3, baseDelay: 1000 })
}
```

### 3.3 Add Graceful VAPI Degradation
**File:** Update `src/components/voice/VoiceCoach.tsx`

```typescript
// Add state for service availability
const [serviceAvailable, setServiceAvailable] = useState(true)

// Check VAPI service on mount
useEffect(() => {
  const checkService = async () => {
    try {
      const response = await fetch('/api/health')
      const health = await response.json()
      setServiceAvailable(health.services.vapi?.status === 'healthy')
    } catch {
      setServiceAvailable(false)
    }
  }
  checkService()
}, [])

// Show fallback UI when unavailable
if (!serviceAvailable) {
  return (
    <Card className="p-6 text-center">
      <p className="text-muted-foreground">
        Voice service temporarily unavailable. Please try again later.
      </p>
      <Button onClick={() => window.location.reload()} className="mt-4">
        Retry
      </Button>
    </Card>
  )
}
```

---

## Phase 4: Deployment Configuration

### 4.1 Create `.nvmrc`
```
20.17.0
```

### 4.2 Create `.env.example`
```env
# Supabase (Public)
NEXT_PUBLIC_SUPABASE_URL=https://[project-id].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...

# Supabase (Secret - Server Only)
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# VAPI (Public)
NEXT_PUBLIC_VAPI_PUBLIC_KEY=...

# VAPI (Secret - Server Only)
VAPI_PRIVATE_KEY=...
VAPI_WEBHOOK_SECRET=...

# AI APIs (Secret - Server Only)
OPENAI_API_KEY=sk-...
OPENROUTER_API_KEY=...

# App Config (Public)
NEXT_PUBLIC_SITE_URL=https://yourdomain.com

# Monitoring (Public)
NEXT_PUBLIC_SENTRY_DSN=https://...@sentry.io/...
```

### 4.3 Create `vercel.json`
```json
{
  "buildCommand": "next build",
  "outputDirectory": ".next",
  "installCommand": "npm ci",
  "framework": "nextjs"
}
```

### 4.4 Create CI/CD Pipeline
**File:** `.github/workflows/ci.yml`

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Unit tests
        run: npm run test

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_VAPI_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPI_PUBLIC_KEY }}
          NEXT_PUBLIC_SITE_URL: https://staging.example.com

  e2e:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ secrets.STAGING_URL }}
```

### 4.5 Add SEO Files
**File:** `src/app/robots.ts`
```typescript
import { MetadataRoute } from 'next'

export default function robots(): MetadataRoute.Robots {
  return {
    rules: {
      userAgent: '*',
      allow: '/',
      disallow: ['/api/', '/practice/', '/analyze/', '/curriculum/'],
    },
    sitemap: 'https://yourdomain.com/sitemap.xml',
  }
}
```

**File:** `src/app/sitemap.ts`
```typescript
import { MetadataRoute } from 'next'

export default function sitemap(): MetadataRoute.Sitemap {
  return [
    {
      url: 'https://yourdomain.com',
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 1,
    },
    {
      url: 'https://yourdomain.com/login',
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.8,
    },
    {
      url: 'https://yourdomain.com/signup',
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.8,
    },
  ]
}
```

---

## Phase 5: Data Protection

### 5.1 Add Audit Log Table
**File:** `supabase/migrations/004_audit_log.sql`

```sql
-- Audit log table for tracking sensitive operations
CREATE TABLE audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  table_name TEXT NOT NULL,
  record_id UUID,
  operation TEXT NOT NULL CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
  user_id UUID REFERENCES auth.users(id),
  old_data JSONB,
  new_data JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for querying by user and table
CREATE INDEX idx_audit_log_user ON audit_log(user_id);
CREATE INDEX idx_audit_log_table ON audit_log(table_name);
CREATE INDEX idx_audit_log_created ON audit_log(created_at);

-- RLS for audit log (admin only)
ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admins can view audit logs" ON audit_log
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid() AND users.role = 'admin'
    )
  );

-- Audit function
CREATE OR REPLACE FUNCTION audit_trigger_func()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO audit_log (table_name, record_id, operation, user_id, old_data, new_data)
  VALUES (
    TG_TABLE_NAME,
    COALESCE(NEW.id, OLD.id),
    TG_OP,
    auth.uid(),
    CASE WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD) ELSE NULL END,
    CASE WHEN TG_OP != 'DELETE' THEN to_jsonb(NEW) ELSE NULL END
  );
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Add triggers to sensitive tables
CREATE TRIGGER audit_call_uploads
  AFTER INSERT OR UPDATE OR DELETE ON call_uploads
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_func();

CREATE TRIGGER audit_roleplay_sessions
  AFTER INSERT OR UPDATE OR DELETE ON roleplay_sessions
  FOR EACH ROW EXECUTE FUNCTION audit_trigger_func();
```

### 5.2 Add Soft Delete Support
**File:** `supabase/migrations/005_soft_delete.sql`

```sql
-- Add soft delete columns
ALTER TABLE roleplay_sessions ADD COLUMN deleted_at TIMESTAMPTZ;
ALTER TABLE call_uploads ADD COLUMN deleted_at TIMESTAMPTZ;
ALTER TABLE session_scores ADD COLUMN deleted_at TIMESTAMPTZ;

-- Update RLS policies to exclude deleted records
DROP POLICY IF EXISTS "Users can view their own sessions" ON roleplay_sessions;
CREATE POLICY "Users can view their own sessions" ON roleplay_sessions
  FOR SELECT USING (auth.uid() = user_id AND deleted_at IS NULL);

DROP POLICY IF EXISTS "Users can view their own uploads" ON call_uploads;
CREATE POLICY "Users can view their own uploads" ON call_uploads
  FOR SELECT USING (auth.uid() = user_id AND deleted_at IS NULL);

-- Soft delete function
CREATE OR REPLACE FUNCTION soft_delete()
RETURNS TRIGGER AS $$
BEGIN
  NEW.deleted_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 Add GDPR Data Export Endpoint
**File:** `src/app/api/user/export/route.ts`

```typescript
import { NextResponse } from 'next/server'
import { createClient, getUser } from '@/lib/supabase/server'

export async function GET() {
  const user = await getUser()
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const supabase = await createClient()

  // Fetch all user data
  const [sessions, uploads, progress, scores] = await Promise.all([
    supabase.from('roleplay_sessions').select('*').eq('user_id', user.id),
    supabase.from('call_uploads').select('*').eq('user_id', user.id),
    supabase.from('curriculum_progress').select('*').eq('user_id', user.id),
    supabase.from('session_scores').select('*, roleplay_sessions!inner(user_id)')
      .eq('roleplay_sessions.user_id', user.id),
  ])

  const exportData = {
    exportDate: new Date().toISOString(),
    user: {
      id: user.id,
      email: user.email,
    },
    roleplaySessions: sessions.data || [],
    callUploads: uploads.data || [],
    curriculumProgress: progress.data || [],
    sessionScores: scores.data || [],
  }

  return new NextResponse(JSON.stringify(exportData, null, 2), {
    headers: {
      'Content-Type': 'application/json',
      'Content-Disposition': `attachment; filename="user-data-export-${user.id}.json"`,
    },
  })
}
```

---

## Phase 6: Performance Optimization

### 6.1 Dynamic Imports for Heavy Components
**File:** Update pages that use voice components

```typescript
import dynamic from 'next/dynamic'

const VoicePractice = dynamic(
  () => import('@/components/voice/VoicePractice'),
  {
    loading: () => <div className="animate-pulse h-96 bg-muted rounded-lg" />,
    ssr: false
  }
)

const VoiceCoach = dynamic(
  () => import('@/components/voice/VoiceCoach'),
  {
    loading: () => <div className="animate-pulse h-96 bg-muted rounded-lg" />,
    ssr: false
  }
)
```

### 6.2 Add metadataBase
**File:** Update `src/app/layout.tsx`

```typescript
export const metadata: Metadata = {
  metadataBase: new URL('https://yourdomain.com'),
  // ... rest of metadata
}
```

### 6.3 Strengthen Password Requirements
**File:** Update `src/app/signup/actions.ts`

```typescript
function validatePassword(password: string): string | null {
  if (password.length < 8) {
    return 'Password must be at least 8 characters'
  }
  if (!/[A-Z]/.test(password)) {
    return 'Password must contain an uppercase letter'
  }
  if (!/[a-z]/.test(password)) {
    return 'Password must contain a lowercase letter'
  }
  if (!/[0-9]/.test(password)) {
    return 'Password must contain a number'
  }
  return null
}

// Use in signup action
const passwordError = validatePassword(password)
if (passwordError) {
  return { error: passwordError }
}
```

### 6.4 Migrate Rate Limiting to Redis
**File:** Update `src/lib/rate-limit.ts`

```typescript
import { Redis } from '@upstash/redis'

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
})

export async function checkRateLimit(
  key: string,
  limit: number,
  windowMs: number
): Promise<{ allowed: boolean; remaining: number; resetAt: number }> {
  const now = Date.now()
  const windowKey = `ratelimit:${key}:${Math.floor(now / windowMs)}`

  const count = await redis.incr(windowKey)
  if (count === 1) {
    await redis.pexpire(windowKey, windowMs)
  }

  return {
    allowed: count <= limit,
    remaining: Math.max(0, limit - count),
    resetAt: Math.ceil(now / windowMs) * windowMs,
  }
}
```

---

## Implementation Order

| Phase | Items | Effort | Priority |
|-------|-------|--------|----------|
| **1** | Security headers, error boundaries, webhook auth, knowledge auth | 2-3 hours | P0 |
| **2** | Sentry, logging, health check, analytics | 3-4 hours | P0 |
| **3** | Circuit breaker, DB retry, graceful degradation | 2-3 hours | P1 |
| **4** | CI/CD, env docs, SEO files | 2-3 hours | P1 |
| **5** | Audit log, soft delete, GDPR export | 3-4 hours | P1 |
| **6** | Dynamic imports, password, Redis rate limit | 2-3 hours | P2 |

**Total Estimated Effort:** 14-20 hours

---

## New Environment Variables Required

Add to `.env.example` and Vercel:
```env
# New additions
VAPI_WEBHOOK_SECRET=...
NEXT_PUBLIC_SENTRY_DSN=...
UPSTASH_REDIS_REST_URL=...
UPSTASH_REDIS_REST_TOKEN=...
```

---

## Post-Implementation Checklist

- [ ] All Phase 1 items complete
- [ ] All Phase 2 items complete
- [ ] All Phase 3 items complete
- [ ] All Phase 4 items complete
- [ ] All Phase 5 items complete
- [ ] All Phase 6 items complete
- [ ] Run `npm run test` - all pass
- [ ] Run `npm run build` - no errors
- [ ] Run `npm run test:e2e` - all pass
- [ ] Verify Sentry receiving events
- [ ] Verify health check endpoint
- [ ] Re-run production audit - score 85+
